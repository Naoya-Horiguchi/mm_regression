# MM regression kernel test tool

本テストツールはカーネル開発にリグレッションを確認したり、バグ検出時にテストコードを共有する目的で開発・メンテしています。

# 前提条件

前提条件として、テストを走行するシステムに `gcc`, `ruby`, `numactl` がインストールされている必要があります。
その他、テストケースによってはライブラリやツールが必要となることもありますが、不足している場合エラーメッセージ等で分かるようになっているはずなので、適宜インストールしてください。

# 使用方法

本テストツールは root ユーザで実行することを想定しています。
基本的な実行方法は下記のコマンドで、これを実行するとデフォルトで走行対象のテストケースを全て、フォアグラウンドプロセスとして実行します。
```
$ git clone https://github.com/Naoya-Horiguchi/mm_regression
$ cd mm_regression
$ make
$ bash run.sh
```

実際はカーネル開発を効率よく行うためにテスト走行条件や走行するテストケースを指定したいことがあります。
以下ではそのために用意した細かい設定や走行方法について説明します。

## テストプロジェクト (RUNNAME)

一連のテストを走行する際、同じ環境条件で走らせた結果をひとまとめに管理するためにテストプロジェクトという概念を導入しています。
これはテストケース走行時に環境変数 `RUNNAME` にセットされた文字列によって指定されます。
テストを走行すると走行結果は全てディレクトリ `work/$RUNNAME` 配下に記録されます。
このディレクトリ配下には簡単な環境情報 (`work/$RUNNAME/environment`) も格納しています。
`RUNNAME` を指定しなかった場合、デフォルト値として "debug" が用いられます。

## テストケース

テストケースはレシピファイルで管理され、基本的に 1 ファイル 1 テストケースを定義します。
レシピファイルは `cases` 配下に格納され、ファイルパスがテストケースの ID となる文字列です。
一部のテストケースは、パラメータだけ変えたテンプレートから自動生成することができ、効率よくテストケースを記述できるようにしています。
現在のバージョンでは拡張子 `.set3` を持つファイルは、テストケースを生成するためのテンプレートで、`make split_recipes` によって拡張子 `.auto3` を持ったレシピファイルが生成されます。
定義されているレシピ一覧を表示するには `make allrecipes` を実行します。

## レシピリスト

デフォルトでは、全てのテストケースが走行対象です。
全てのテストケースを実行するには時間がかかるため、実務上現在のテスト観点に応じて一部のテストケースだけ走行したいときがあります。
テストプロジェクトの準備段階で全テストケースの中から走行対象とするテストケースを選択することができます。
具体的には `work/$RUNNAME/recipelist` にテストケース ID のリストを保存することで走行対象のテストケースを指定します。
全テストケースのリストが `work/$RUNNAME/full_recipe_list` に保存されているので、適当なキーワードでフィルタしてやるのが簡単でしょう。

```
# work/$RUNNAME を準備
$ make prepare

$ grep <keyword> work/$RUNNAME/full_recipe_list > work/$RUNNAME/recipelist
$ bash run.sh
```

あるいは実行したいテストケースがレシピファイルのレベルで分かっている場合、例えば以下のように `run.sh` に渡す引数として直接指定することもできます。
~~~
$ bash run.sh cases/mm/compaction
~~~

## サマリ出力

テストプロジェクトの走行結果や (テストが中断した場合などは) 走行状況を把握する必要がありますが、スクリプト `test_core/lib/test_summary.rb` を用いてテストプロジェクトの状況を確認できます。

```
$ ruby test_core/lib/test_summary.rb work/testrun/
Progress: 428 / 455 (94%)
PASS 307, FAIL 29, WARN 4, SKIP 88, NONE 27

$ ruby test_core/lib/test_summary.rb -C work/testrun/
PASS 20200814/102319 [10] cases/mm/thp/swap
FAIL 20200814/102351 [10] cases/mm/thp/anonymous/split_retry_thp-base.auto3
FAIL 20200814/102431 [10] cases/mm/thp/anonymous/split_retry_thp-double_mapping.auto3
PASS 20200814/102441 [10] cases/mm/thp/anonymous/split_retry_thp-pmd_split.auto3
...
Progress: 428 / 455 (94%)
Target: work/testrun
```

`-C` オプションを用いると、テストケースごとのより詳細な情報を表示できます。各列は左から順番に、テスト状態・結果、完了時刻、テストケース優先度、テストケースID を意味します。

## 走行モード (BACKGROUND)

テストケースの中にはリブートを伴うものがあります。テスト自動化の観点から、リブートを含めて最後まで自動で走りきらせたいことがあります。
この場合、環境変数 `BACKGROUND` をセットして、本テストツールをバックグラウンドモードで実行します。

`BACKGROUND` を指定した場合、`run.sh` はすぐに返りますが、test.service という systemd サービスが登録・起動され、テストが systemd の配下で実行されます。
この状況でシステムが再起動した場合、再起動後に自動的にテストプロセスが再実行され、直前まで実行していたテストケースの続きからテストを継続できます。

```
BACKGROUND=true bash run.sh
```

## その他、テスト実行に関する tips

その他、テスト走行に関する細かい要求を実現するために、本テストツールは以下のような機能を持っています。
その多くは環境変数によってコントロールされます。

- `AGAIN`: デバッグ用途で本テストツールを用いる場合、同じテストを複数回走らせる必要が生じます。テストプロジェクトのディレクトリ `work/$RUNNAME` 配下でテストの経過を記録しているため、デフォルトでは実行済みのテストケースはスキップされます。実行済みテストケースを再実行するためには環境変数 `AGAIN` を指定する必要があります。
  ```
  AGAIN=true bash run.sh
  ```

- `LOGLEVEL`: 数値をセットしてログレベルを指定します。デフォルトは 1 で、 2 にするとログが増え、0 にするとログを減らせます。
- `SOFT_RETRY`: デフォルトは 3 で、あるテストケースを `SOFT_RETRY` 回実行して 1 回でも成功すればそのテストケースはパスしたとみなします。
- `HARD_RETRY`: デフォルトは 1 で、あるテストケースを `HARD_RETRY` 回実行して全て成功すればそのテストケースはパスしたとみなします。`SOFT_RETRY` と `HARD_RETRY` の両方を 2 以上にした場合、`SOFT_RETRY` 回失敗するまでに「`HARD_RETRY` 回連続で成功」すればパスとみなします。
- `PRIORITY`: 各テストケースにはテストごとの優先度が定められています。0-20 までの数字で表現され、数字が小さいほど優先度が高いとみなします。環境変数 `PRIORITY` は実行するテストケースの優先度範囲を指定します。`PRIORITY=0-10,12,15-18` のようにカンマ区切りで複数回指定することや、ハイフンで範囲指定することができます。デフォルトは `PRIORITY=0-10` です。
- `RUN_MODE`: 一部のテストケースは一時的な再現目的で作られただけで、長期間メンテすることが想定されていないものがあります。そのようなテストケースはデフォルトで流れないようにしてあるため、そのようなテストケースを実行したいときだけ、`RUN_MODE=devel` のように指定します。
- `FAILRETRY`: TODO
- `BACKWARD_KEYWORD`: テスト対象のカーネルや実行環境のバージョンによっては、期待動作が変わることがあります。この環境変数にキーワードを指定した時、そのキーワードに紐付けられた期待動作として古い期待動作を採用します。upstream カーネルに新機能が入り、そのカーネルがパスするようテストケースは追随しつつ、古いカーネルでも正しくテストしたい場合に有用です。
- `FORWARD_KEYWORD`: `BACKWARD_KEYWORD` と同様、期待動作の異なる振る舞いを選択するための環境変数です。この環境変数にキーワードを指定した時、そのキーワードに紐付けられた期待動作として新しい期待動作を採用します。今すぐ upstream に入る機能ではないが、開発版のカーネルでパスするテストケースを書きたい場合に有用です。

# テストケース開発者向け

以下では、テストケース開発者向けに、本テストツールの走行の流れやテストケースの追加方法について説明します。

## テストケースの構成

一つのテストケースは一つのレシピファイルで定義されます。
レシピファイルは基本的には bash シェルスクリプトです。
レシピファイルはそのテストケース内だけで有効な変数を定義することができ、以下の 4 つの関数を実行します。
- `_prepare()`: テストケースを実行する際の事前条件チェックや準備処理を記述します。テストケースを実行する条件を満たしていなかったり、準備処理に失敗した場合は非ゼロを返し、その場合テストロジック (`_control()`) は実行されません。
- `_control()`: テストケースを実現するためのロジックを記述します。
- `_cleanup()`: `_prepare()` に副作用を伴う準備処理が実行された場合、それをクリーンアップする処理を記述します。
- `_check()`: `_control()` 処理中に採取した情報をベースにテストの pass/fail 判定する必要がある場合に処理を記述します。

これらが必要かどうかはテストケースに依存しており、単純なものでは `_control()` しか持たないテストケースもあります。
pass/fail 判定は返り値ベースだと解像度が足りないので、カスタムリターンコードを使用します。
テストケースに変数 `EXPECTED_RETURN_CODE` が指定されているとき、テスト走行中に期待通りのコードパスを通ったかどうかをチェックします。

```
EXPECTED_RETURN_CODE="START CHECK1 END"

_control() {
    set_return_code START
    test_logic
    if [ $? -eq 0 ] ; then
        set_return_code CHECK1
    fi
    ...
    set_return_code END
}
```
この場合、test_logic が成功して if 文内を通った場合にパスします。
理解しやすいリターンコードを定義することで、期待動作を管理しやすくなります。

## テストの走行の流れ

本テストツールは、`work/$RUNNAME/recipelist` で指定されたテストケースのリストを上から順番に実行します。
レシピファイルの階層構造には意味があり、各ディレクトリごとに管理用のサブプロセスを作成し、各テストケースは別のサブプロセスで実行されます。
これはディレクトリ単位で環境変数を効率よく継承させていくとともに、あるテストケースのために定義した変数や関数が後のテストケースの動作に干渉することを避けられます。

例えば、下記のような `recipelist` があったとします。
```
cases/test1
cases/dir1/test2
cases/dir1/dir2/test3
cases/dir1/test4
cases/test5
```
この場合、以下の様な流れに沿ってテストケースは実行されます。
```
main thread
  |---> sub thread
  |     run cases/test1
  |---> sub thread
  |     (source cases/dir1/config)
  |       |---> sub thread
  |       |     run cases/dir1/test2
  |       |---> sub thread
  |       |     (source cases/dir1/dir2/config)
  |       |       |---> sub thread
  |       |       |     run cases/dir1/dir2/test3
  |       |     (dir_cleanup() in cases/dir1/dir2/config)
  |       |---> sub thread
  |       |     run cases/dir1/test4
  |      (dir_cleanup() in cases/dir1/config)
  |---> sub thread
  |     run cases/test5
  *
```
各テストケースごとにサブスレッドで実行されるだけでなく、ディレクトリを下る際にもサブスレッドを生成しています。
あるディレクトリ配下の全てのテストに共通の設定を `config` ファイルに書くことによって、共通の準備処理や事前チェックをまとめて行うことができます。
また、`config` 内に関数 `dir_cleanup()` を定義することにより、共通のクリーンナップ処理を実行できます。

## テストケース開発時の tips

### 変数

以下の変数はテストケースのコンテキストで利用できる変数です。
- `GTMPD`: テストプロジェクトのディレクトリ (`work/$RUNNAME`) を指します。テストをコントロールするためのファイルがいくつか格納されています。
- `RTMPD`: 各テストケースの情報を格納するディレクトリを指します。例えば `cases/dir1/test2` というテストケースの実行時は、`RTMPD=work/$RUNNAME/dir1/test2` となります。
- `TMPD`: 各リトライラウンドごとの情報を格納するディレクトリを指します。例えば、`SOFT_RETRY` の 2 回目、`HARD_RETRY` の 3 回目のラウンドでは、`TMPD=$RTMPD/2-3` となります。テストロジックの中間ファイルは基本的にこのディレクトリ配下に保存するようにします。

以下はテストケース内で定義することでテストの動作に影響を与える変数です。
- `MAX_REBOOT`: リブートを想定したテストケースにおいて、無限にリブートをループするのを防ぐため、リブート回数の最大値を設定します。デフォルトは 0 です。
- `TEST_PRIORITY`: テストの優先度を設定します。デフォルトは 10 です。テストケースの中には時間がかかるものや重要度が低いものがあるので、テストを走行する・しない、あるいは走行順序を指定するのに利用します。
- `TEST_TYPE`: 開発中のテストや、他の理由でテストケースにタグをつけたい時に利用します。このパラメータは現時点で仕様がはっきりさせていないため、利用時は注意が必要です。

### その他

- 全テストを流す場合、カーネルパニック発生時に再起動する仕組み (ダンプを設定したり、ブートパラメータ `panic=<N>` を指定する) を有効にしておくのが望ましいです。
