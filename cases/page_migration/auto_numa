. $TRDIR/setup_page_migration.sh

NUMA_NODE=2
THP=1
MIGRATE_SRC=auto_numa

EXPECTED_RETURN_CODE="START MIGRATION_PASSED HUGEPAGE_MIGRATED EXIT"
TEST_PROGRAM="$test_alloc_generic -a numa_prepared -o page_migration -s $MIGRATE_SRC -N $THP -B thp -w start -w after_allocate -w before_free -w exit"

get_numa_maps() { cat /proc/$1/numa_maps; }

INIT_NUMA_BALANCING=$(cat /proc/sys/kernel/numa_balancing)

_prepare() {
	prepare_mm_generic || return 1

	khpd_off

    # numa balancing should be enabled
    echo 1 > /proc/sys/kernel/numa_balancing
    echo 1 > /proc/sys/kernel/numa_balancing_scan_delay_ms
    echo 100 > /proc/sys/kernel/numa_balancing_scan_period_max_ms
    echo 100 > /proc/sys/kernel/numa_balancing_scan_period_min_ms
    echo 1024 > /proc/sys/kernel/numa_balancing_scan_size_mb
}

_cleanup() {
	cleanup_mm_generic

    echo $INIT_NUMA_BALANCING > /proc/sys/kernel/numa_balancing
    echo 1000 > /proc/sys/kernel/numa_balancing_scan_delay_ms
    echo 60000 > /proc/sys/kernel/numa_balancing_scan_period_max_ms
    echo 1000 > /proc/sys/kernel/numa_balancing_scan_period_min_ms
    echo 256 > /proc/sys/kernel/numa_balancing_scan_size_mb
}
