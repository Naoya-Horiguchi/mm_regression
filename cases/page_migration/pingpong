. $TRDIR/setup_page_migration.sh

NUMA_NODE=2
HUGEPAGESIZE=2048 # kB
HUGETLB=500
HUGETLB_MOUNT=$WDIR/mount
EXPECTED_RETURN_CODE="START EXIT"

PINGPONG_DURATION=10

_control() {
    echo_log "start hugepage_pingpong"
	grep ^pgmigrate /proc/vmstat | tee $TMPD/vmstat.pgmigrate1
    echo "$test_alloc_generic -B pagecache -B anonymous -B thp -B hugetlb_anon -B hugetlb_shmem -N 10 -L \"start mmap access mbind_pingpong\" > $TMPD/fuz.out 2>&1 &"
    $test_alloc_generic -B pagecache -B anonymous -B thp -B hugetlb_anon -B hugetlb_shmem -N 10 -L "start mmap access mbind_pingpong" > $TMPD/fuz.out 2>&1 &
    local pid=$!
    echo_log "pid $pid"
    sleep $PINGPONG_DURATION
	ps ax | grep $pid
    pkill -SIGUSR1 $pid
	grep ^pgmigrate /proc/vmstat | tee $TMPD/vmstat.pgmigrate2
    set_return_code EXIT
}
