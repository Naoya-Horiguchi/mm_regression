. $TRDIR/setup_page_migration.sh

NUMA_NODE=2
HUGEPAGESIZE=2048 # kB
HUGETLB=500
HUGETLB_MOUNT=$WDIR/mount
HUGETLB_FILE=$HUGETLB_MOUNT/testfile
EXPECTED_RETURN_CODE="START EXIT"

PINGPONG_DURATION=10

_control() {
    echo_log "start hugepage_pingpong"
	grep ^pgmigrate /proc/vmstat | tee $TMPD/vmstat.pgmigrate1
    echo "$test_alloc_generic -v -a allocate_exit -o mbind_pingpong -N 10 -d work -B pagecache -B anonymous -B thp -B hugetlb_anon -B hugetlb_shmem > $TMPD/fuz.out 2>&1 &"
    $test_alloc_generic -a allocate_exit -o mbind_pingpong -N 10 -d work -B pagecache -B anonymous -B thp -B hugetlb_anon -B hugetlb_shmem > $TMPD/fuz.out 2>&1 &
    local pid=$!
    echo_log "pid $pid"
    sleep $PINGPONG_DURATION
	ps ax | grep $pid
    pkill -SIGUSR2 $pid
	grep ^pgmigrate /proc/vmstat | tee $TMPD/vmstat.pgmigrate2
    set_return_code EXIT
}
