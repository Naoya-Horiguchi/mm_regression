. $TRDIR/setup_page_migration.sh

NUMA_NODE=2
HUGEPAGESIZE=2048 # kB
HUGETLB=500
EXPECTED_RETURN_CODE="START EXIT"

_control() {
	grep ^pgmigrate /proc/vmstat | tee $TMPD/vmstat.pgmigrate1
	for i in $(seq 5) ; do
        $test_alloc_generic -a iterate_mapping -B hugetlb_anon -N 10 &
		local pid=$!
		for j in $(seq 100) ; do
		    do_migratepages $pid 0 1
		    do_migratepages $pid 1 0
		done
		kill -SIGUSR1 $pid 2> /dev/null
	done
	grep ^pgmigrate /proc/vmstat | tee $TMPD/vmstat.pgmigrate2
	set_return_code EXIT
}

_prepare() {
	prepare_hugepage_migration || return 1
}

_cleanup() {
	cleanup_hugepage_migration
}

_check() {
	check_hugepage_migration
}
