. $TRDIR/setup_page_migration.sh

NUMA_NODE=2
HUGEPAGESIZE=2048 # kB
HUGETLB=500
HUGETLB_MOUNT=$WDIR/mount
HUGETLB_FILE=$HUGETLB_MOUNT/testfile
EXPECTED_RETURN_CODE="START EXIT"

PINGPONG_NR_PROC=4
PINGPONG_NR_HPS=10
PINGPONG_ALLOC_TYPES=0xff
PINGPONG_DURATION=100

NUMA_MAPS_READER=${TMPF}.read_numa_maps.sh
cat <<EOF > ${NUMA_MAPS_READER}
for pid in \$@ true ; do
    cat /proc/\$pid/numa_maps > /dev/null 2>&1
done
EOF

_control() {
    local nr_proc=$PINGPONG_NR_PROC
    local nr_hps=$PINGPONG_NR_HPS
    local type=$PINGPONG_ALLOC_TYPES
    local i=
    local pids=""
    echo_log "start $nr_proc hugepage_pingpong processes"
	grep ^pgmigrate /proc/vmstat | tee $TMPD/vmstat.pgmigrate1
    for i in $(seq $nr_proc) ; do
        $hugepage_pingpong -n $nr_hps -t $type > $TMPD/fuz.out$i 2>&1 &
        pids="$pids $!"
    done
    sleep $PINGPONG_DURATION
    kill -SIGUSR1 $pids
	grep ^pgmigrate /proc/vmstat | tee $TMPD/vmstat.pgmigrate2
    set_return_code EXIT
}

_prepare() {
    prepare_hugepage_migration || return 1
}

_cleanup() {
    cleanup_hugepage_migration
}

_check() {
    check_hugepage_migration
}
