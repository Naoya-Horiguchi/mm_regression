. $TRDIR/setup_mce_test.sh

EXPECTED_RETURN_CODE="START EXIT"

TESTFILE="$WDIR/testfile"

HUGETLB=300
HUGETLB_MOUNT=$WDIR/hugetlbfs
HUGETLB_FILE=$HUGETLB_MOUNT/testfile

POISON_ITERATION=100
TIMEOUT=30

random_poison() {
	local target=0x100
	local injtype=$INJECT_TYPE
	local maxpfn=0x$($PAGETYPES -NL | tail -n1 | cut -f1)

	while true ; do
		echo "$MCEINJECT -e $injtype -a $target"
		$MCEINJECT -e $injtype -a $target
		target=$[(target + $RANDOM) % $maxpfn]
	done
	pkill -9 -f random_unpoison
}

random_unpoison() {
    local pid=$1
	while true ; do 
        $PAGETYPES -N -b hwpoison -x
    done
}

_control() {
    random_poison &
    local pid_poison=$!
    random_unpoison &
    local pid_unpoison=$!
	sleep $TIMEOUT
	kill -9 $pid_poison $pid_unpoison
    kill -SIGUSR1 $pid
    set_return_code EXIT
}

_prepare() {
	prepare_mce_test || return 1
}

_cleanup() {
	cleanup_mce_test
}

_check() {
	check_mce_test
}
