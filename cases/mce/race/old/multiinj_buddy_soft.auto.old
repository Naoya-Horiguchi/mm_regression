. $TRDIR/setup_mce_test.sh

EXPECTED_RETURN_CODE="START EXIT"

TESTFILE="$WDIR/testfile"

HUGETLB=300
HUGETLB_MOUNT=$WDIR/hugetlbfs
HUGETLB_FILE=$HUGETLB_MOUNT/testfile

POISON_ITERATION=100
TIMEOUT=30

random_poison() {
    local i=
    local j=
    local pos=
    local pid=$1
    local range=

	$PAGETYPES -p $pid -Nlr -a 0x700000000+0x100000000 | cut -f1 | grep 00$ > $TMPD/mapping
    for i in $(cat $TMPD/mapping) ; do
        for j in $(seq 0 511) ; do
            echo "$[0x$i + j]" >> $TMPD/pfnlist
        done
    done

	while read line ; do
		$PAGETYPES -N -p $pid -a 0x$line -X 2> /dev/null
	done < $TMPD/pfnlist
	pkill -9 -f random_unpoison
}

random_unpoison() {
    local pid=$1
	while true ; do 
        $PAGETYPES -N -p $pid -b hwpoison -x
    done
}

_control() {
    local pid=

	$test_alloc_generic -o multi_backend -d work -b -n 4096 &
    pid=$!

    random_poison $pid &
    local pid_poison=$!
    random_unpoison $pid &
    local pid_unpoison=$!
	sleep $TIMEOUT
	kill -9 $pid_poison $pid_unpoison
    kill -SIGUSR1 $pid
    set_return_code EXIT
}

_prepare() {
	prepare_mce_test || return 1
}

_cleanup() {
	cleanup_mce_test
}

_check() {
	check_mce_test
}
