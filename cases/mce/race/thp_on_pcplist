. $TRDIR/setup_mce_test.sh

ERROR_TYPE=hard-offline
EXPECTED_RETURN_CODE="START EXIT"
POISON_ITERATION=3
TARGET_PAGEFLAG="thp,compound_head=thp,compound_head"
THP=true

background_alloc_exit() {
	while true ; do
		$test_alloc_generic -o alloc_exit -B thp -n $[512 * 512 * 4096]
	done
}

_control() {
    background_alloc_exit &
    local backpid=$!

    for i in $(seq $POISON_ITERATION) ; do
        $PAGETYPES -r -b $TARGET_PAGEFLAG -Nl | grep -v offset | cut -f1 | while read line ; do
            $MCEINJECT -e $ERROR_TYPE -a 0x$line
        done
    done

    kill -9 $backpid
    set_return_code EXIT
}
