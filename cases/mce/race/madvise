. $TRDIR/setup_mce_test.sh

EXPECTED_RETURN_CODE="START EXIT"

HUGETLB=500

BACKENDOPT="-B pagecache -B anonymous -B thp -B hugetlb_anon -B hugetlb_shmem -B hugetlb_file -B ksm -B normal_shmem"
OPERATIONS="start mmap access madv_stress"

_control() {
    for i in $(seq 10) ; do
		$test_alloc_generic $BACKENDOPT -N 8 -e madv_hard -L "$OPERATIONS" > /dev/null 2>&1 &
		$test_alloc_generic $BACKENDOPT -N 8 -e madv_soft -L "$OPERATIONS" > /dev/null 2>&1 &
		$test_alloc_generic $BACKENDOPT -N 8 -e madv_hard -A -L "$OPERATIONS" > /dev/null 2>&1 &
		$test_alloc_generic $BACKENDOPT -N 8 -e madv_soft -A -L "$OPERATIONS" > /dev/null 2>&1 &
    done
	sleep 3

	# Without below, some hugepage remains as surplus after cleanup_mm_generic()
	rm -rf $HUGETLB_MOUNT/* 2>&1 > /dev/null
	umount -f $HUGETLB_MOUNT 2>&1 > /dev/null
	sysctl -q vm.nr_hugepages=0
	kill_all_subprograms
	all_unpoison
	ipcrm --all > /dev/null 2>&1
	show_hugetlb_pool
    set_return_code EXIT
}
